<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>CFD 宏观插件与计算器</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <style>
    body, button, select {margin:0; padding:0; font-family:'Inter',sans-serif; color:#24292f;}
    .dashboard{display:flex;height:100vh;}
    .container{flex:1;overflow-y:auto;padding:1rem;}
    .calendar-container{background:#fff;border-right:1px solid #e1e4e8;display:flex;flex-direction:column;}
    .checklist-container{background:#fafbfc;}
    .title{text-align:center;font-weight:bold;margin-bottom:8px;font-size:18px;}
    #calendar{flex:1;max-height:calc(100vh - 120px);}
    #eventDetails{margin-top:8px;padding:8px;background:#f5f5f5;font-size:14px;}
    .fc button{background:none;border:none;color:#24292f;font-size:16px;padding:6px 12px;}
    .fc-header-toolbar{margin-bottom:8px;}
    .iframe-wrapper{width:100%;height:calc(100vh - 60px);border:none;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
</head>
<body>
<div class="dashboard">
  <div class="container calendar-container">
    <div class="title">宏观日历</div>
    <div id="calendar"></div>
    <div id="eventDetails">点击日期查看事件详情</div>
  </div>
  <div class="container checklist-container">
    <div class="title">成本与风险计算</div>
    <iframe src="checklist.html" class="iframe-wrapper"></iframe>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',() => {
  const calendarEl = document.getElementById('calendar');
  const detailEl   = document.getElementById('eventDetails');

  /* 中英文 + 缩写映射 */
  const zhMap = {
    'JOLTS Job Openings':'职位空缺 (JOLTS)',
    'AUD CPI q/q':'澳洲CPI季环比 (CPIq)',
    'AUD CPI y/y':'澳洲CPI年同比 (CPIy)',
    'Trimmed Mean CPI q/q':'裁剪均值CPI季环比 (TMC)',
    'ADP Non‑Farm Employment Change':'ADP非农就业 (ADP)',
    'Federal Funds Rate':'联邦基金利率 (FFR)',
    'FOMC Statement':'FOMC 声明 (FOMC)',
    'FOMC Press Conference':'FOMC 新闻发布会 (FOMCPC)',
    'Core PCE Price Index m/m':'核心PCE月率 (PCE)',
    'Employment Cost Index q/q':'就业成本指数季环比 (ECI)',
    'Unemployment Claims':'初请失业金 (IC)',
    'Average Hourly Earnings m/m':'平均时薪月率 (AHE)',
    'Non‑Farm Employment Change (NFP)':'非农就业 (NFP)',
    'Unemployment Rate':'失业率 (UR)'
  };

  /* 获取缩写：括号优先，否则大写首字母 */
  function getAbbrev(enTitle){
    const zh = zhMap[enTitle];
    if(zh && zh.match(/\((.*?)\)/)) return zh.match(/\((.*?)\)/)[1].toUpperCase();
    const paren = enTitle.match(/\((.*?)\)/);
    if(paren) return paren[1].toUpperCase();
    return enTitle.split(/\s+/).map(w=>w[0]).join('').toUpperCase();
  }

  /* 事件分类存储 */
  const eventsByDate = {};

  const calendar = new FullCalendar.Calendar(calendarEl,{
    initialView:'dayGridMonth',
    locale:'zh-cn',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''
    },
    eventDidMount(info){
      // 加粗 & 按国家上色
      const country = info.event.extendedProps.country;
      info.el.style.fontWeight = 'bold';
      info.el.style.backgroundColor = '#000';
      info.el.style.color = country==='US' ? '#e11d48' : '#ffffff';
    },
    dateClick(info){
      const list = eventsByDate[info.dateStr] || [];
      if(!list.length){ detailEl.textContent='此日期无事件'; return;}
      const us = list.filter(e=>e.country==='US');
      const au = list.filter(e=>e.country==='AU');
      let html = '';
      if(us.length){
        html += '<strong>美国</strong><br>';
        us.forEach((e,i)=>{html += `${i+1}. ${e.date} – ${e.zhName} (${e.timeAEST} AEST | ${e.timeEDT} EDT)<br>`;});
      }
      if(au.length){
        html += '<br><strong>澳洲</strong><br>';
        au.forEach((e,i)=>{html += `${i+1}. ${e.date} – ${e.zhName} (${e.timeAEST} AEST | ${e.timeEDT} EDT)<br>`;});
      }
      detailEl.innerHTML = html;
    }
  });
  calendar.render();

  /* 读取 events.csv */
  fetch('events.csv')
    .then(r=>r.text())
    .then(txt=>{
      txt.trim().split(/\r?\n/)
        .filter(l=>l && !l.startsWith('#') && !/^Date,/i.test(l))
        .forEach(row=>{
          const [dateStr,enTitle,sydISO] = row.split(',');
          if(!sydISO) return;
          const sydDate = new Date(sydISO);
          const timeAEST = sydDate.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Australia/Sydney'});
          const timeEDT  = sydDate.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/New_York'});
          const zhName   = zhMap[enTitle] || enTitle;
          const abbrev   = getAbbrev(enTitle);
          const country  = enTitle.startsWith('AUD') ? 'AU' : 'US';

          (eventsByDate[dateStr] = eventsByDate[dateStr] || []).push({date:dateStr, zhName, timeAEST, timeEDT, country});

          calendar.addEvent({date:dateStr,title:abbrev,extendedProps:{country}});
        });
    })
    .catch(err=>{detailEl.textContent='events.csv 加载失败'; console.error(err);});
});
</script>
</body>
</html>
